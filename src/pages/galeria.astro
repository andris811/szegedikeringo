---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import Gallery from '../components/Gallery.astro';
import { content } from '../content.js';
import fs from 'fs';
import path from 'path';

const lang = 'hu';
const galleryContent = content[lang].gallery;

// Category configuration with labels
const categoryConfig = [
  { key: 'all', label: galleryContent.filter.all },
  { key: 'breeding', label: galleryContent.filter.breeding },
  { key: 'young', label: galleryContent.filter.young },
  { key: 'flying', label: galleryContent.filter.flying },
  { key: 'events', label: galleryContent.filter.events },
];

// Dynamically load images from category folders
const galleryItems: Array<{ src: string; alt: string; category: string }> = [];
const imageExtensions = ['.jpg', '.jpeg', '.png', '.webp'];

// Categories to scan (excluding 'all')
const categoriesToScan = ['flying', 'breeding', 'young', 'events'];

categoriesToScan.forEach((category) => {
  const categoryPath = path.join(process.cwd(), 'public', 'images', 'gallery', category);

  // Check if directory exists
  if (fs.existsSync(categoryPath)) {
    const files = fs.readdirSync(categoryPath);

    files.forEach((file) => {
      const ext = path.extname(file).toLowerCase();
      if (imageExtensions.includes(ext)) {
        galleryItems.push({
          src: `/images/gallery/${category}/${file}`,
          alt: `Szegedi Magasszálló Keringő - ${categoryConfig.find(c => c.key === category)?.label || category}`,
          category: category
        });
      }
    });
  }
});

// Category labels for display
const categoryLabels: Record<string, string> = {
  flying: galleryContent.filter.flying,
  breeding: galleryContent.filter.breeding,
  young: galleryContent.filter.young,
  events: galleryContent.filter.events,
};
---

<Layout
  title="Galéria | Szegedi Magasszálló Keringő Tenyészet"
  description="Gyönyörű fotók a Szegedi Magasszálló Keringő galambokról - törzsállomány, repülés, kiállítások"
>
  <!-- Hero Section -->
  <Hero
    title={galleryContent.title}
    subtitle={galleryContent.subtitle}
    image="/images/hero/gallery.jpg"
  />

  <!-- Filter Section -->
  <section class="py-12 bg-gradient-to-b from-primary-50 dark:from-gray-800 to-white dark:to-gray-900 transition-colors">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-wrap justify-center gap-3 mb-4">
        {categoryConfig.map((category) => (
          <button
            class={`filter-btn px-6 py-2.5 rounded-full font-medium transition-all duration-300 transform hover:scale-105 ${
              category.key === 'all'
                ? 'bg-primary-600 dark:bg-gray-600 text-white shadow-lg'
                : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-primary-100 dark:hover:bg-gray-600 hover:shadow-md shadow-sm'
            }`}
            data-category={category.key}
          >
            {category.label}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Gallery Grid -->
  <section class="py-16 bg-white dark:bg-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="gallery-grid">
        {galleryItems.map((item, index) => (
          <div
            class={`gallery-item group relative overflow-hidden rounded-xl shadow-lg hover:shadow-2xl transition-all duration-500 bg-white dark:bg-gray-700 transform hover:-translate-y-2 ${item.category}`}
            style={`animation-delay: ${index * 50}ms;`}
          >
            <div class="aspect-square overflow-hidden bg-gradient-to-br from-primary-100 to-primary-200 relative">
              <!-- Actual image -->
              <img
                src={item.src}
                alt={item.alt}
                class="gallery-img w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500 cursor-pointer"
                data-index={index}
                loading="lazy"
                onerror="this.style.display='none'; this.parentElement.querySelector('.placeholder-content').classList.remove('hidden');"
              />
              <!-- Placeholder fallback (hidden by default) -->
              <div class="placeholder-content hidden absolute inset-0 w-full h-full bg-gradient-to-br from-primary-200 via-primary-300 to-primary-400 flex items-center justify-center">
                <!-- Decorative background pattern -->
                <div class="absolute inset-0 opacity-10">
                  <svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                      <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <circle cx="20" cy="20" r="1" fill="currentColor"/>
                      </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)"/>
                  </svg>
                </div>
                <!-- Bird icon -->
                <div class="relative">
                  <svg class="w-20 h-20 text-white/40" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M23.5 8.5c0-1.1-.9-2-2-2h-3.2L14 2.2C13.5 1.8 12.8 1.5 12 1.5s-1.5.3-2 .7L5.7 6.5H2.5c-1.1 0-2 .9-2 2 0 .8.5 1.5 1.2 1.8L8 13.5v5c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2v-5l6.3-3.2c.7-.3 1.2-1 1.2-1.8z"/>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Overlay with caption -->
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-500 pointer-events-none">
              <div class="absolute bottom-0 left-0 right-0 p-6 transform translate-y-4 group-hover:translate-y-0 transition-transform duration-500">
                <p class="text-white font-semibold text-lg mb-1">{item.alt}</p>
                <p class="text-white/80 text-sm flex items-center">
                  <span class="w-2 h-2 bg-primary-400 rounded-full mr-2"></span>
                  {categoryLabels[item.category] || item.category}
                </p>
              </div>
            </div>

            <!-- Corner accent -->
            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
              <div class="w-8 h-8 border-t-2 border-r-2 border-white/50 rounded-tr-lg"></div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="fixed inset-0 bg-black/95 z-50 hidden items-center justify-center">
    <button
      id="close-lightbox"
      class="absolute top-4 right-4 text-white hover:text-primary-400 transition-colors z-50"
      aria-label="Bezárás"
    >
      <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <button
      id="prev-image"
      class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-primary-400 transition-colors p-2 hover:bg-white dark:bg-gray-800/10 rounded-full"
      aria-label="Előző"
    >
      <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </button>

    <button
      id="next-image"
      class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-primary-400 transition-colors p-2 hover:bg-white dark:bg-gray-800/10 rounded-full"
      aria-label="Következő"
    >
      <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </button>

    <div class="max-w-7xl max-h-screen w-full h-full flex flex-col items-center justify-center p-8">
      <img
        id="lightbox-image"
        src=""
        alt=""
        class="max-w-full max-h-[85vh] object-contain rounded-lg"
      />
      <div class="mt-6 text-center">
        <p id="lightbox-caption" class="text-white text-lg font-medium mb-2"></p>
        <p id="lightbox-category" class="text-white/70 text-sm"></p>
        <p id="lightbox-counter" class="text-white/50 text-sm mt-2"></p>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ galleryItems, categoryLabels }}>
  // Gallery data for lightbox (passed from server-side)
  const galleryData = galleryItems.map(item => ({
    src: item.src,
    alt: item.alt,
    category: categoryLabels[item.category] || item.category
  }));

  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const galleryItems = document.querySelectorAll('.gallery-item');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const lightboxCategory = document.getElementById('lightbox-category');
    const lightboxCounter = document.getElementById('lightbox-counter');
    const closeLightbox = document.getElementById('close-lightbox');
    const prevBtn = document.getElementById('prev-image');
    const nextBtn = document.getElementById('next-image');
    let currentIndex = 0;

    // Filter functionality
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const category = button.dataset.category;

        // Update active button
        filterButtons.forEach(btn => {
          btn.classList.remove('bg-primary-600', 'text-white', 'shadow-lg');
          btn.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200', 'shadow-sm');
        });
        button.classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200', 'shadow-sm');
        button.classList.add('bg-primary-600', 'dark:bg-gray-600', 'text-white', 'shadow-lg');

        // Filter items
        galleryItems.forEach(item => {
          if (category === 'all' || item.classList.contains(category)) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });
      });
    });

    // Lightbox functionality
    function openLightbox(index) {
      currentIndex = index;
      updateLightbox();
      lightbox?.classList.remove('hidden');
      lightbox?.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeLightboxFn() {
      lightbox?.classList.add('hidden');
      lightbox?.classList.remove('flex');
      document.body.style.overflow = '';
    }

    function updateLightbox() {
      const item = galleryData[currentIndex];
      if (lightboxImage && lightboxCaption && lightboxCategory && lightboxCounter && item) {
        lightboxImage.src = item.src;
        lightboxImage.alt = item.alt;
        lightboxCaption.textContent = item.alt;
        lightboxCategory.textContent = item.category;
        lightboxCounter.textContent = `${currentIndex + 1} / ${galleryData.length}`;
      }
    }

    function showNext() {
      currentIndex = (currentIndex + 1) % galleryData.length;
      updateLightbox();
    }

    function showPrev() {
      currentIndex = (currentIndex - 1 + galleryData.length) % galleryData.length;
      updateLightbox();
    }

    // Event listeners
    document.querySelectorAll('.gallery-img').forEach((img) => {
      img.addEventListener('click', () => {
        const index = parseInt(img.dataset.index || '0');
        openLightbox(index);
      });
    });

    closeLightbox?.addEventListener('click', closeLightboxFn);
    prevBtn?.addEventListener('click', showPrev);
    nextBtn?.addEventListener('click', showNext);

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!lightbox?.classList.contains('hidden')) {
        if (e.key === 'Escape') closeLightboxFn();
        if (e.key === 'ArrowLeft') showPrev();
        if (e.key === 'ArrowRight') showNext();
      }
    });

    // Close on background click
    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) closeLightboxFn();
    });
  });
</script>

<style>
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
  }

  .gallery-item {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .gallery-grid {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }
  }

  @media (max-width: 640px) {
    .gallery-grid {
      grid-template-columns: 1fr;
      gap: 1.25rem;
    }
  }
</style>